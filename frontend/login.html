<!--
  ARQUIVO: frontend/login.html
  DESCRI√á√ÉO: P√°gina de login e registro
  
  Esta p√°gina permite que usu√°rios fa√ßam login ou criem nova conta
  Ambos os formul√°rios enviam dados para o servidor (server.js)
-->

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - GameStore</title>
    <style>
        /*
          CSS para p√°gina de login
          Comentado em portugu√™s para fins educacionais
        */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Linear gradient = degrad√™ de cor de um lado a outro */
        }

        .container-login {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            /* box-shadow = sombra para efeito de profundidade */
            width: 100%;
            max-width: 400px;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        /* Guias de abas (Login / Registro) */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: #999;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab-btn.ativo {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-conteudo {
            display: none;
        }

        .tab-conteudo.ativo {
            display: block;
        }

        /* Grupo de formul√°rio */
        .grupo-form {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            font-size: 1rem;
            /* Transi√ß√£o suave ao focar */
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }

        /* Bot√£o de envio */
        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* Mensagens de erro/sucesso */
        .mensagem {
            padding: 12px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }

        .mensagem.erro {
            background-color: #ffe0e0;
            color: #c41e3a;
            display: block;
            border-left: 4px solid #c41e3a;
        }

        .mensagem.sucesso {
            background-color: #e0ffe0;
            color: #1e7c1e;
            display: block;
            border-left: 4px solid #1e7c1e;
        }

        .indicador-forca {
            margin-top: 5px;
            height: 5px;
            background: #ddd;
            border-radius: 3px;
            overflow: hidden;
        }

        .barra-forca {
            height: 100%;
            width: 0%;
            background: red;
            transition: all 0.3s ease;
        }

        .forca-fraca { background: red !important; }
        .forca-media { background: orange !important; }
        .forca-forte { background: green !important; }

        .voltar {
            text-align: center;
            margin-top: 20px;
        }

        .voltar a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }
        /* Modal de verifica√ß√£o de email */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }
        .modal-box input {
            text-align: center;
            letter-spacing: 5px;
            font-size: 24px;
            margin: 20px 0;
        }
    </style>
</head>
<body>

    <!-- Modal de Verifica√ß√£o de Email -->
    <div id="modalVerificacao" class="modal-overlay">
        <div class="modal-box">
            <h2>üìß Verifique seu Email</h2>
            <p>Enviamos um c√≥digo de 6 d√≠gitos para <strong id="emailVerificacao"></strong>.</p>
            <p><small>(Verifique tamb√©m a caixa de spam)</small></p>
            
            <input type="text" id="codigoInput" placeholder="000000" maxlength="6">
            <button onclick="confirmarCodigo()" class="btn-submit">Confirmar C√≥digo</button>
            <p id="erroVerificacao" class="erro"></p>
        </div>
    </div>

    <div class="container-login">
        <!-- Logo -->
        <h1>üéÆ GameStore</h1>

        <!-- Abas (Login / Registro) -->
        <div class="tabs">
            <button class="tab-btn ativo" onclick="trocarAba('login')">
                Login
            </button>
            <button class="tab-btn" onclick="trocarAba('registro')">
                Criar Conta
            </button>
        </div>

        <!-- ====== ABA 1: LOGIN ====== -->
        <div id="login" class="tab-conteudo ativo">
            <form id="formLogin" onsubmit="handleLogin(event)">
                <!-- Mensagem de erro/sucesso -->
                <div id="mensagemLogin" class="mensagem"></div>

                <!-- Campo Email -->
                <div class="grupo-form">
                    <label for="emailLogin">Email:</label>
                    <input 
                        type="email" 
                        id="emailLogin" 
                        placeholder="seu@email.com"
                        required
                    >
                </div>

                <!-- Campo Senha -->
                <div class="grupo-form">
                    <label for="senhaLogin">Senha:</label>
                    <input 
                        type="password" 
                        id="senhaLogin" 
                        placeholder="Sua senha"
                        required
                    >
                </div>

                <!-- Bot√£o -->
                <button type="submit" class="btn">
                    Entrar
                </button>
            </form>
        </div>

        <!-- ====== ABA 2: REGISTRO ====== -->
        <div id="registro" class="tab-conteudo">
            <form id="formRegistro" onsubmit="handleRegistro(event)">
                <!-- Mensagem de erro/sucesso -->
                <div id="mensagemRegistro" class="mensagem"></div>

                <!-- Campo Nome -->
                <div class="grupo-form">
                    <label for="nome">Seu Nome:</label>
                    <input 
                        type="text" 
                        id="nome" 
                        placeholder="Jo√£o Silva"
                        required
                        minlength="3"
                    >
                </div>

                <!-- Campo Email -->
                <div class="grupo-form">
                    <label for="emailRegistro">Email:</label>
                    <input 
                        type="email" 
                        id="emailRegistro" 
                        placeholder="seu@gmail.com ou seu@hotmail.com"
                        required
                    >
                    <!-- Dica sobre dom√≠nios permitidos -->
                    <small style="color: #999; margin-top: 5px; display: block;">
                        Use Gmail, Hotmail, Outlook ou Yahoo
                    </small>
                </div>

                <!-- Campo Senha -->
                <div class="grupo-form">
                    <label for="senhaRegistro">Senha:</label>
                    <input 
                        type="password" 
                        id="senhaRegistro" 
                        placeholder="M√≠nimo 8 caracteres"
                        required
                        minlength="8"
                        onchange="verificarForcaSenha()"
                    >
                    <!-- Indicador de for√ßa da senha -->
                    <div class="indicador-forca">
                        <div id="barraForca" class="barra-forca"></div>
                    </div>
                    <small id="textoForca" style="color: #999; margin-top: 5px; display: block;">
                        Senha fraca
                    </small>
                </div>

                <!-- Dicas de senha -->
                <small style="color: #999; display: block; margin-bottom: 20px;">
                    ‚úì M√≠nimo 8 caracteres<br>
                    ‚úì Mai√∫scula, min√∫scula, n√∫mero e s√≠mbolo
                </small>

                <!-- Bot√£o -->
                <button type="submit" class="btn">
                    Criar Conta
                </button>
            </form>
        </div>

        <!-- Link para voltar -->
        <div class="voltar">
            <a href="/">‚Üê Voltar ao site</a>
        </div>
    </div>

    <!-- ====== JAVASCRIPT ====== -->
    <script>
        /*
          ARQUIVO: frontend/login.html (JavaScript)
          DESCRI√á√ÉO: L√≥gica de login e registro
          
          Este c√≥digo roda no navegador do usu√°rio.
          Valida dados e envia para o servidor.
        */

        // ============================================
        // FUN√á√ÉO: Trocar entre abas (Login / Registro)
        // ============================================
        function trocarAba(abaDestino) {
            // Ocultar todas as abas
            document.querySelectorAll('.tab-conteudo').forEach(aba => {
                aba.classList.remove('ativo');
            });

            // Desativar todos os bot√µes de abas
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('ativo');
            });

            // Mostrar aba selecionada
            document.getElementById(abaDestino).classList.add('ativo');

            // Ativar bot√£o da aba selecionada
            event.target.classList.add('ativo');
        }

        // ============================================
        // FUN√á√ÉO: Mostrar mensagem
        // ============================================
        function mostrarMensagem(elementoId, texto, tipo) {
            /*
              elementoId = ID do elemento onde mostrar
              texto = mensagem a exibir
              tipo = 'erro' ou 'sucesso'
            */
            const elemento = document.getElementById(elementoId);
            
            // Limpar classes
            elemento.classList.remove('erro', 'sucesso');
            
            // Adicionar classe apropriada
            elemento.classList.add(tipo);
            
            // Escrever texto
            elemento.textContent = texto;
        }

        // ============================================
        // FUN√á√ÉO: Verificar for√ßa da senha
        // ============================================
        function verificarForcaSenha() {
            const senha = document.getElementById('senhaRegistro').value;
            const barra = document.getElementById('barraForca');
            const texto = document.getElementById('textoForca');

            let forca = 0;

            // Verificar crit√©rios
            if (senha.length >= 8) forca++;           // Tamanho m√≠nimo
            if (/[A-Z]/.test(senha)) forca++;         // Mai√∫scula
            if (/[a-z]/.test(senha)) forca++;         // Min√∫scula
            if (/[0-9]/.test(senha)) forca++;         // N√∫mero
            if (/[!@#$%^&*]/.test(senha)) forca++;    // Caractere especial

            // Atualizar barra de progresso
            const percentual = (forca / 5) * 100;
            barra.style.width = percentual + '%';

            // Mudar cor baseado na for√ßa
            barra.classList.remove('forca-fraca', 'forca-media', 'forca-forte');

            if (forca <= 2) {
                barra.classList.add('forca-fraca');
                texto.textContent = '‚ùå Senha fraca';
            } else if (forca <= 4) {
                barra.classList.add('forca-media');
                texto.textContent = '‚ö†Ô∏è Senha m√©dia';
            } else {
                barra.classList.add('forca-forte');
                texto.textContent = '‚úÖ Senha forte';
            }
        }

        // Vari√°vel para armazenar email temporariamente
        let emailParaVerificar = '';

        // ============================================
        // FUN√á√ÉO: Handle Login
        // ============================================
        async function handleLogin(event) {
            /*
              event.preventDefault() = impedir recarregar p√°gina
            */
            event.preventDefault();

            const email = document.getElementById('emailLogin').value;
            const senha = document.getElementById('senhaLogin').value;
            
            // Limpar mensagens anteriores
            document.getElementById('mensagemLogin').textContent = '';

            try {
                // Enviar dados para o servidor
                const resposta = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, senha })
                });

                // Converter resposta para JSON
                const dados = await resposta.json();

                if (resposta.ok) {
                    // Se sucesso, salvar token e redirecionar
                    mostrarMensagem('mensagemLogin', '‚úÖ Login realizado!', 'sucesso');
                    
                    // Salvar no LocalStorage (navegador)
                    localStorage.setItem('token', dados.token);
                    localStorage.setItem('usuario', JSON.stringify(dados.usuario));
                    
                    // Redirecionar para home ap√≥s 1 segundo
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    // Se erro
                    if (dados.precisaVerificar) {
                        emailParaVerificar = dados.email;
                        abrirModalVerificacao(dados.email);
                    } else {
                        mostrarMensagem('mensagemLogin', dados.erro, 'erro');
                    }
                }
            } catch (erro) {
                console.error(erro);
                mostrarMensagem('mensagemLogin', '‚ùå Erro de conex√£o com servidor', 'erro');
            }
        }

        // ============================================
        // FUN√á√ÉO: Handle Registro
        // ============================================
        async function handleRegistro(event) {
            event.preventDefault();

            const nome = document.getElementById('nome').value;
            const email = document.getElementById('emailRegistro').value;
            const senha = document.getElementById('senhaRegistro').value;

            // Limpar mensagens
            document.getElementById('mensagemRegistro').textContent = '';

            try {
                // Enviar dados para o servidor
                const resposta = await fetch('/api/auth/registro', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nome, email, senha })
                });

                const dados = await resposta.json();

                if (resposta.ok) {
                    // SUCESSO!
                    mostrarMensagem('mensagemRegistro', dados.mensagem, 'sucesso');
                    
                    if (dados.precisaVerificar) {
                        emailParaVerificar = dados.email;
                        setTimeout(() => abrirModalVerificacao(dados.email), 1500);
                    }
                } else {
                    // ERRO
                    mostrarMensagem('mensagemRegistro', dados.erro, 'erro');
                }
            } catch (erro) {
                console.error(erro);
                mostrarMensagem('mensagemRegistro', '‚ùå Erro de conex√£o com servidor', 'erro');
            }
        }

        // FUN√á√ÉO: Abrir modal de verifica√ß√£o
        function abrirModalVerificacao(email) {
            document.getElementById('emailVerificacao').innerText = email;
            document.getElementById('modalVerificacao').style.display = 'flex';
        }

        // FUN√á√ÉO: Confirmar c√≥digo OTP
        async function confirmarCodigo() {
            const codigo = document.getElementById('codigoInput').value;
            const erroMsg = document.getElementById('erroVerificacao');
            
            try {
                const response = await fetch('/api/auth/verificar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: emailParaVerificar, codigo })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('‚úÖ Conta verificada com sucesso! Agora fa√ßa login.');
                    window.location.reload(); // Recarregar para limpar formul√°rios
                } else {
                    erroMsg.innerText = data.erro || 'C√≥digo inv√°lido';
                    erroMsg.style.color = 'red';
                }
            } catch (err) {
                console.error(err);
                erroMsg.innerText = 'Erro ao verificar c√≥digo';
            }
        }
    </script>
</body>
</html>
